import{k as P,r as v,c as b,_ as q,A as M,B as R,d as n,bi as m,db as D,D as d,bI as F,ab as x,bN as L,aZ as k,an as U,cw as A,au as z,cx as $,cz as B}from"./index.3bd8bff3.js";import{Q as O}from"./QSelect.8411b3cd.js";import{Q as E}from"./QPage.85fd4be8.js";import{u as j}from"./use-quasar.94e7f076.js";import{H as C,I as W,q as g}from"./quickbase.7e9e049d.js";import{dayjs as V}from"./dayjs.238de433.js";import{u as X}from"./dataStore.8ec64a1e.js";import{Q as J}from"./QInnerLoading.3103f2e0.js";import{a as H}from"./QTable.fa96a81a.js";import{_ as Z}from"./projectSelector.fbac68a3.js";import"./QChip.fff575e1.js";import"./QItemLabel.349706c0.js";import"./QMenu.ade1759f.js";import"./position-engine.6bd25d23.js";import"./selection.d55c238c.js";import"./rtl.cf9bbe47.js";import"./_commonjsHelpers.a26ce4be.js";import"./index.7dbe61ef.js";import"./localForage.cfd98bcf.js";import"./i18n.475c5698.js";import"./api.a28dd52c.js";import"./QList.3180ed89.js";import"./QMarkupTable.2024054c.js";import"./use-fullscreen.9bbdec53.js";const G=P({name:"Arrivals Table",components:{},props:{rows:Array,selected:Array},setup(r,i){const u=j(),t=v(!1),f=b(()=>u.screen.gt.sm?[{name:1,label:"Name",align:"left",field:e=>e[31],format:e=>`${e}`,sortable:!0},{name:2,label:"Workday ID",align:"left",field:e=>e[152],format:(e,s)=>s[20]==="In Process"?"W---------":e,sortable:!0},{name:3,label:"Project",align:"left",field:e=>e[171],format:e=>`${e}`,sortable:!0},{name:4,label:"Classification",align:"left",field:e=>e[45],format:e=>`${e}`,sortable:!0},{name:5,label:"Job Number",align:"left",field:e=>e[85],format:e=>`${!e||e===""?"Not Assigned":e}`,sortable:!0},{name:6,label:"Site Contact",align:"left",field:e=>e[186],format:e=>`${e===""||!e?"Not Assigned":e}`,sortable:!0},{name:7,label:"Start Date",align:"left",field:e=>e[33].$d,format:e=>`${C.formatDate(new Date(e),"MM/DD/YYYY")}`,sortable:!0}]:[{name:1,label:"Name",align:"left",field:e=>e[31],format:e=>`${e}`,sortable:!0},{name:2,label:"Workday ID",align:"left",field:e=>e[152],format:(e,s)=>s[20]==="In Process"?"W---------":e,sortable:!0},{name:3,label:"Project",align:"left",field:e=>e[171],format:e=>`${e}`,sortable:!0},{name:4,label:"Classification",align:"left",field:e=>e[45],format:e=>`${e}`,sortable:!0},{name:5,label:"Job Number",align:"left",field:e=>e[85],format:e=>`${!e||e===""?"Not Assigned":e}`,sortable:!0},{name:6,label:"Site Contact",align:"left",field:e=>e[186],format:e=>`${e===""||!e?"Not Assigned":e}`,sortable:!0},{name:7,label:"Start Date",align:"left",field:e=>e[33].$d,format:e=>`${C.formatDate(new Date(e),"MM/DD/YYYY")}`,sortable:!0}]);function p({rows:e,added:s,evt:c}){t.value=!0,i.emit("arrivalMarked",{record:e[0],added:s}),setTimeout(function(){t.value=!1},1500)}return{columns:f,updateArrivals:p,props:r,loading:t}}}),K={class:"q-px-sm"},ee={class:"full-width row flex-center text-primary q-gutter-sm q-py-md"};function ae(r,i,u,t,f,p){return M(),R("div",K,[n(H,{dense:"",columns:r.columns,rows:r.props.rows,"row-key":e=>e[3],class:"q-pa-sm",pagination:{rowsPerPage:r.$q.screen.gt.sm?25:100},separator:"vertical",selection:"multiple",onSelection:r.updateArrivals,selected:r.props.selected,"table-header-class":"bg-dark text-white","no-data-label":"There are no expected arrivals",loading:r.loading,grid:r.$q.screen.lt.md},{"header-selection":m(e=>[n(D,{disable:"",modelValue:e.selected,"onUpdate:modelValue":s=>e.selected=s},null,8,["modelValue","onUpdate:modelValue"])]),"body-selection":m(e=>[n(D,{label:r.$q.screen.lt.sm?"Arrived":"",modelValue:e.selected,"onUpdate:modelValue":s=>e.selected=s},null,8,["label","modelValue","onUpdate:modelValue"])]),"no-data":m(({message:e})=>[d("div",ee,[n(F,{size:"2em",name:"fa-solid fa-person-circle-exclamation"}),d("span",null,x(e),1)])]),loading:m(()=>[n(J,{showing:"",color:"primary"})]),_:1},8,["columns","rows","row-key","pagination","onSelection","selected","loading","grid"])])}var te=q(G,[["render",ae]]);const le={name:"Arrivals",components:{MarkArrivalsTable:te,projectSelector:Z},setup(){const r=j(),i=W(),u=v(null),t=v(""),f=v(""),{getSelectedProject:p}=L(i),{fetchAllDeployments:e,updateDeployment:s,getDeployments:c}=X(),h=b(()=>p.value?p.value[3]:null),S=b(()=>c(h.value).filter(a=>a[20]==="Complete")),w=b(()=>{let a=[];return c(h.value).forEach(l=>{l[31].toLowerCase().includes(f.value.toLowerCase())&&a.push(l)}),a=t.value?a.filter(l=>V(l[33].$d).tz("America/Chicago").format("MM/DD/YYYY")===V(t.value).tz("America/Chicago").format("MM/DD/YYYY")):a,a=u.value?a.filter(l=>l[132]===u.value):a,a}),Y=b(()=>[...new Map(w.value.map(a=>[a[132],a[132]])).values()]);async function Q(){r.loading.show(),await e(),r.loading.hide()}async function I({record:a,added:l}){if(l){await N(a),await y({id:a[21],status:7});const o=await _(a[3],"Complete");s({projectId:o[134],key:o[3],record:o})}else{await T(a),await y({id:a[21],status:6});const o=await _(a[3],"In Process");s({projectId:o[134],key:o[3],record:o})}}async function N(a){try{const{data:l}=await g.upsertRecordsXML({to:"bp3gazpqj",data:[{6:{value:a[3]},13:{value:a[15]},18:{value:a[21]},60:{value:""}}],fieldsToReturn:[108],formatObject:108},{action:"create",type:"arrival"});return l[0][108]}catch(l){throw{message:"Cannot add assignment",error:l}}}async function y({id:a,status:l}){try{const{data:o}=await g.upsertRecordsXML({to:"bp3gb7ng2",data:[{3:{value:a},79:{value:l}}],fieldsToReturn:[3]});return o[0][3]}catch(o){throw{message:"Cannot edit employee",error:o}}}async function _(a,l){try{const{data:o}=await g.upsertRecordsXML({to:"bp3gaymc3",data:[{3:{value:a},20:{value:l},22:{value:new Date}}],fieldsToReturn:[204],formatObject:204});return o[0][204]}catch(o){throw{message:"Cannot edit deployment",error:o}}}async function T(a){try{const{data:l}=await g.upsertRecordsXML({to:"bp3gazpqj",data:[{3:{value:a.assignment[3]},22:{value:new Date},21:{value:"Canceled"},19:{value:""},60:{value:""}}],fieldsToReturn:[108],formatObject:108});return l[0][108]}catch(l){throw{message:"Cannot cancel assignment",error:l}}}return Q(),{arrived:S,allDeployments:w,arrivalMarked:I,craftOptions:Y,craftFilter:u,startDateFilter:t,search:f}}},oe={class:"q-pt-sm"},re={class:"text-h5 text-dark"},se={class:"text-body2 text-italic q-ml-sm"},ne=d("div",{class:"text-subtitle2 text-accent"},"Please toggle the switch for everyone that has arrived at the job site.",-1),ie={class:"row items-center"},de={class:"col-12 col-md-3 q-px-sm"},ce={class:"col-12 col-md-3 q-px-sm"},me={class:"col-12 col-md-3 q-px-sm"},ue={class:"col-12 col-md-3 q-px-sm"};function fe(r,i,u,t,f,p){const e=k("projectSelector"),s=k("mark-arrivals-table");return M(),U(E,{style:{"max-width":"100vw"}},{default:m(()=>[d("div",oe,[n(B,{flat:""},{default:m(()=>[n(A,{class:"q-pb-none"},{default:m(()=>[d("div",re,[z(" Expected Arrivals "),d("span",se,"("+x(t.allDeployments.length)+" total)",1)]),ne]),_:1}),n(A,null,{default:m(()=>[d("div",ie,[d("div",de,[n(e,{dense:""})]),d("div",ce,[n($,{dense:"",modelValue:t.search,"onUpdate:modelValue":i[0]||(i[0]=c=>t.search=c),label:"Search"},null,8,["modelValue"])]),d("div",me,[n($,{dense:"",modelValue:t.startDateFilter,"onUpdate:modelValue":i[1]||(i[1]=c=>t.startDateFilter=c),label:"Arrival Date",type:"date","stack-label":""},null,8,["modelValue"])]),d("div",ue,[n(O,{dense:"",label:"Craft","transition-show":"flip-up","transition-hide":"flip-down",modelValue:t.craftFilter,"onUpdate:modelValue":i[2]||(i[2]=c=>t.craftFilter=c),options:t.craftOptions,"use-chips":""},null,8,["modelValue","options"])])])]),_:1})]),_:1}),n(s,{rows:t.allDeployments,selected:t.arrived,onArrivalMarked:t.arrivalMarked},null,8,["rows","selected","onArrivalMarked"])])]),_:1})}var Pe=q(le,[["render",fe]]);export{Pe as default};
